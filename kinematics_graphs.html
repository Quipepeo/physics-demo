<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Kinematics Simulator</title>

  <!-- Chart.js + dragData plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-dragdata@2/dist/chartjs-plugin-dragdata.min.js"></script>

  <style>
    body { font-family: sans-serif; margin: 20px; }
    h1 { text-align: center; }
    #controls {
      max-width: 800px; margin: 0 auto 20px;
      display: grid; grid-template-columns: repeat(auto-fit,minmax(150px,1fr));
      gap: 10px; align-items: end;
    }
    #controls label { display: block; font-weight: bold; margin-bottom: 4px; }
    #controls input[type="number"] { width: 100%; }
    #buttons { grid-column: span 2; text-align: center; margin-top: 10px; }
    #charts {
      display: flex; flex-wrap: wrap; justify-content: space-around;
      gap: 20px; max-width: 1200px; margin: 0 auto;
    }
    .chart-container {
      position: relative; flex: 1 1 300px; max-width: 380px;
    }
    .chart-container canvas {
      width: 100% !important; height: auto !important;
    }
    .axis-signs {
      position: absolute; top: 0; left: 0;
      width: 100%; height: 100%; pointer-events: none;
      font-size: 1.2em; color: #555;
    }
    .axis-signs .py-plus  { position: absolute; left: 4px;  top: 4px; }
    .axis-signs .py-minus { position: absolute; left: 4px;  bottom: 4px; }
    .axis-signs .px-plus  { position: absolute; right: 4px; bottom: 4px; }
  </style>

  <script>
    Chart.register(ChartDragDataPlugin);

    // helper to generate [start, start+step, …, stop]
    function linspace(start, stop, step) {
      const out = [];
      for (let v = start; v <= stop + 1e-9; v += step) {
        out.push(+v.toFixed(6));
      }
      return out;
    }

    let posChart, velChart, accChart;
    let accPts = [];

    // base chart options
    function baseOpts(duration) {
      return {
        animation: false,
        responsive: true,
        scales: {
          x: {
            type: 'linear',
            min: 0, max: duration,
            grid: { display: false },
            ticks: { display: false, stepSize: 1 }
          },
          y: {
            grid: {
              color: ctx => ctx.tick.value === 0 ? '#000' : 'transparent',
              lineWidth: 1
            },
            ticks: { display: false }
          }
        }
      };
    }

    // initialize charts
    function initCharts() {
      const dur = +document.getElementById('duration').value;

      posChart = new Chart('posChart', {
        type: 'line',
        data: { datasets:[{ data:[], borderColor:'blue', showLine:true }] },
        options: baseOpts(dur)
      });

      velChart = new Chart('velChart', {
        type: 'line',
        data: { datasets:[{ data:[], borderColor:'green', showLine:true }] },
        options: baseOpts(dur)
      });

      accChart = new Chart('accChart', {
        type: 'line',
        data: [{ data:[], borderColor:'red', pointRadius:8, pointBackgroundColor:'red', showLine:true, stepped:true }],
        options: {
          ...baseOpts(dur),
          plugins: {
            dragData: {
              round: 1,
              showTooltip: true,
              dragX: false,
              dragY: true,
              onDrag: (e, ds, idx, val) => {
                accPts[idx] = Math.round(val.y);
                updateAll();
              }
            }
          }
        }
      });
    }

    // compute position & velocity from accPts, with initial x0, v0
    function computeKin(acc, duration, dt, x0, v0) {
      const t = linspace(0, duration, dt);
      const v = [v0], x = [x0];

      for (let i = 1; i < t.length; i++) {
        // linear interp of acceleration between integers
        const tau = t[i - 1];
        const j = Math.floor(tau);
        const frac = tau - j;
        const a_j   = acc[j]   ?? acc[acc.length - 1];
        const a_j1  = acc[j+1] ?? acc[acc.length - 1];
        const a_val = a_j + (a_j1 - a_j) * frac;

        v.push(v[i - 1] + a_val * dt);
        x.push(x[i - 1] + v[i - 1] * dt + 0.5 * a_val * dt * dt);
      }
      return { t, x, v };
    }

    // redraw everything
    function updateAll() {
      const dur   = +document.getElementById('duration').value;
      const dt    = +document.getElementById('dt').value;
      const x0    = +document.getElementById('x0').value;
      const v0    = +document.getElementById('v0').value;
      const showX = document.getElementById('showPos').checked;
      const showV = document.getElementById('showVel').checked;

      // ensure one accPt per integer second
      if (accPts.length !== dur + 1) {
        accPts = Array(dur + 1).fill(0);
      }

      const { t, x, v } = computeKin(accPts, dur, dt, x0, v0);

      // position chart
      posChart.options = baseOpts(dur);
      posChart.data.datasets[0].data = t.map((tt,i) => ({ x: tt, y: x[i] }));
      document.getElementById('posContainer').style.display = showX ? 'block' : 'none';
      posChart.update();

      // velocity chart
      velChart.options = baseOpts(dur);
      velChart.data.datasets[0].data = t.map((tt,i) => ({ x: tt, y: v[i] }));
      document.getElementById('velContainer').style.display = showV ? 'block' : 'none';
      velChart.update();

      // acceleration chart (input)
      accChart.options = { ...baseOpts(dur), plugins: accChart.options.plugins };
      accChart.data.datasets[0].data = accPts.map((a,i) => ({ x: i, y: a }));
      document.getElementById('accContainer').style.display = 'block';
      accChart.update();
    }

    // reset to defaults, including derived accPts from p(t)=t^3-3t^2+5
    function resetAll() {
      document.getElementById('duration').value = 5;
      document.getElementById('dt').value       = 0.1;
      document.getElementById('x0').value       = 5;  // p(0)=5
      document.getElementById('v0').value       = 0;  // p'(0)=0
      document.getElementById('showPos').checked = true;
      document.getElementById('showVel').checked = true;

      const dur = 5;
      accPts = [];
      for (let i = 0; i <= dur; i++) {
        accPts.push(6 * i - 6);
      }

      initCharts();
      updateAll();
    }

    window.onload = () => {
      // wire buttons
      document.getElementById('updateBtn').onclick = updateAll;
      document.getElementById('resetBtn').onclick  = resetAll;
      resetAll();
    };
  </script>
</head>
<body>
  <h1>Kinematics Simulator</h1>

  <div id="controls">
    <div>
      <label for="duration">Duration (s)</label>
      <input type="number" id="duration" value="5" step="1" min="1">
    </div>
    <div>
      <label for="dt">Time Step Δt (s)</label>
      <input type="number" id="dt" value="0.1" step="0.01" min="0.01">
    </div>
    <div>
      <label for="x0">Initial Position x₀</label>
      <input type="number" id="x0" value="5" step="1">
    </div>
    <div>
      <label for="v0">Initial Velocity v₀</label>
      <input type="number" id="v0" value="0" step="1">
    </div>
    <div>
      <label><input type="checkbox" id="showPos" checked> Show Position</label>
      <label><input type="checkbox" id="showVel" checked> Show Velocity</label>
    </div>
    <div id="buttons">
      <button id="updateBtn">Update Graphs</button>
      <button id="resetBtn">Start Over</button>
    </div>
  </div>

  <div id="charts">
    <div class="chart-container" id="posContainer">
      <canvas id="posChart"></canvas>
      <div class="axis-signs">
        <div class="py-plus">+</div>
        <div class="py-minus">−</div>
        <div class="px-plus">t</div>
      </div>
    </div>
    <div class="chart-container" id="velContainer">
      <canvas id="velChart"></canvas>
      <div class="axis-signs">
        <div class="py-plus">+</div>
        <div class="py-minus">−</div>
        <div class="px-plus">t</div>
      </div>
    </div>
    <div class="chart-container" id="accContainer">
      <canvas id="accChart"></canvas>
      <div class="axis-signs">
        <div class="py-plus">+</div>
        <div class="py-minus">−</div>
        <div class="px-plus">t</div>
      </div>
    </div>
  </div>
</body>
</html>
